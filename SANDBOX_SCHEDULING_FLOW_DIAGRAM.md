# E2B Infrastructure Sandbox 调度算法流程图

## 完整调度流程图

```
                             [客户端请求创建 Sandbox]
                                        |
                                        v
                        ┌─────────────────────────────────────┐
                        │         API 网关层                   │
                        │  - 身份验证                         │
                        │  - 请求参数验证                     │
                        │  - 速率限制检查                     │
                        └─────────────────┬───────────────────┘
                                        |
                                        v
                        ┌─────────────────────────────────────┐
                        │       团队资源预约检查               │
                        │  InstanceCache.Reserve()            │
                        │  - 检查团队并发实例限制             │
                        │  - 预约资源防止重复创建             │
                        │  - 返回资源释放函数                 │
                        └─────────────────┬───────────────────┘
                                        |
                                        v
                        ┌─────────────────────────────────────┐
                        │       构建信息验证                   │
                        │  - 获取模板构建信息                 │
                        │  - 验证 Firecracker 版本            │
                        │  - 创建沙盒配置请求                 │
                        └─────────────────┬───────────────────┘
                                        |
                                        v
                             ┌─────────[是否恢复操作?]─────────┐
                             │                                │
                           YES│                              │NO
                             v                                v
            ┌─────────────────────────────────────┐         ┌──────────────────┐
            │      优先节点选择（恢复）           │         │   跳过优先选择   │
            │  - 获取原始快照节点                 │         │                  │
            │  - 检查节点状态是否 Ready           │         │                  │
            │  - 如果不可用则设为 null            │         │                  │
            └─────────────────┬───────────────────┘         └────────┬─────────┘
                             │                                      │
                             └──────────────┬───────────────────────┘
                                           v
                        ┌─────────────────────────────────────┐
                        │       重试循环开始                   │
                        │  - attempt = 1                      │
                        │  - nodesExcluded = {}               │
                        │  - maxNodeRetries = 3               │
                        └─────────────────┬───────────────────┘
                                        |
                                        v
                ┌───────────────────────────────────────────────┐
                │              循环控制检查                     │
                │  1. 检查上下文是否超时/取消                   │
                │  2. 检查重试次数是否超过限制                 │
                │  └──> 失败返回相应错误                       │
                └─────────────────┬─────────────────────────────┘
                                |
                                v
                     ┌─────────[node 是否为 null?]─────────┐
                     │                                     │
                   YES│                                   │NO
                     v                                     v
        ┌─────────────────────────────────────┐         ┌──────────────────┐
        │      节点选择算法                   │         │   使用现有节点   │
        │  getLeastBusyNode()                 │         │                  │
        └─────────────────┬───────────────────┘         └────────┬─────────┘
                         │                                      │
                         └──────────────┬───────────────────────┘
                                       v
                        ┌─────────────────────────────────────┐
                        │       资源预占                       │
                        │  node.sbxsInProgress.Insert()       │
                        │  - 预占内存: build.RamMb            │
                        │  - 预占CPU: build.Vcpu              │
                        └─────────────────┬───────────────────┘
                                        |
                                        v
                        ┌─────────────────────────────────────┐
                        │       沙盒创建请求                   │
                        │  node.Client.Sandbox.Create()       │
                        │  - gRPC调用到Orchestrator节点        │
                        └─────────────────┬───────────────────┘
                                        |
                                        v
                             ┌─────────[创建是否成功?]─────────┐
                             │                                │
                           YES│                              │NO
                             v                                v
                ┌─────────────────────────────────────┐    ┌─────────────────────────────────────┐
                │         创建成功                     │    │         创建失败处理                │
                │  - 跳出重试循环                     │    │  - 释放预占资源                     │
                │  - 返回沙盒实例                     │    │  - 记录失败日志                     │
                │                                     │    │  - 增加节点失败计数                 │
                └─────────────────┬───────────────────┘    │  - 加入排除节点列表                 │
                                |                          │  - attempt++, node=null            │
                                v                          └─────────────────┬───────────────────┘
                     ┌─────────────────────────────────────┐                                │
                     │         最终返回                     │                                │
                     │  - 创建的沙盒实例                   │                                │
                     │  - 包含节点信息                     │                                │
                     │  - 包含资源分配信息                 │                                │
                     └─────────────────────────────────────┘                                │
                                                                                            │
                                    ┌───────────────────────────────────────────────────────┘
                                    v
                        ┌─────────────────────────────────────┐
                        │       返回循环开始                   │
                        │  - 继续下一次重试                   │
                        │  - 使用更新的排除列表               │
                        └─────────────────┬───────────────────┘
                                        |
                                        v
                                    [回到循环控制检查]
```

## 节点选择算法详细流程

```
                        [getLeastBusyNode 开始]
                                |
                                v
                ┌─────────────────────────────────────┐
                │       立即查找节点                   │
                │  findLeastBusyNode()                │
                └─────────────────┬───────────────────┘
                                |
                                v
                     ┌─────────[找到可用节点?]─────────┐
                     │                                │
                   YES│                              │NO
                     v                                v
        ┌─────────────────────────────────────┐    ┌─────────────────────────────────────┐
        │         直接返回                    │    │         轮询等待                    │
        │  - 返回最忙节点                     │    │  - 每10ms检查一次                   │
        └─────────────────────────────────────┘    │  - 设置60秒超时                     │
                                                   │  - 重复调用findLeastBusyNode()      │
                                                   └─────────────────┬───────────────────┘
                                                                    |
                                                                    v
                                                        ┌─────────[超时或找到?]─────────┐
                                                        │                              │
                                                      找到│                            │超时
                                                        v                              v
                                            ┌─────────────────────────┐    ┌──────────────────┐
                                            │      返回节点           │    │   返回超时错误   │
                                            └─────────────────────────┘    └──────────────────┘
```

## findLeastBusyNode 核心算法流程

```
                        [遍历所有节点开始]
                               |
                               v
                    ┌──────────[节点过滤条件]──────────┐
                    │                                 │
                    │  1. node != nil                 │
                    │  2. node.Status() == Ready      │
                    │  3. !在排除列表中               │
                    │  4. 进行中实例数 <= 3           │
                    │                                 │
                    └─────────────────┬───────────────┘
                                     |
                                     v
                           ┌─────────[通过过滤?]─────────┐
                           │                            │
                         YES│                          │NO
                           v                            v
            ┌─────────────────────────────────────┐   ┌──────────────────┐
            │       计算节点负载                   │   │   跳过该节点     │
            │  cpuUsage = 当前CPU使用率 +         │   │                  │
            │             进行中实例CPU需求       │   │                  │
            └─────────────────┬───────────────────┘   └────────┬─────────┘
                             |                                │
                             v                                │
                  ┌─────────[比现有最忙节点更闲?]─────────┐     │
                  │                                     │     │
                YES│                                   │NO   │
                  v                                     v     │
     ┌─────────────────────────────────────┐          ┌──────┴─────────┐
     │      更新最忙节点                   │          │    继续下一节点 │
     │  leastBusyNode = currentNode        │          │                │
     └─────────────────┬───────────────────┘          └────────────────┘
                      │                                       │
                      └───────────────┬───────────────────────┘
                                     |
                                     v
                          ┌─────────[还有更多节点?]─────────┐
                          │                                │
                        YES│                              │NO
                          v                                v
                  [继续遍历下一个节点]              ┌─────────────────────────┐
                          |                        │      返回结果           │
                          └────────────────────────┤  - 最忙节点 或 null     │
                                                   │  - 对应错误信息         │
                                                   └─────────────────────────┘
```

## 资源管理和监控流程

```
                        [资源预占系统]
                               |
                  ┌────────────┴────────────┐
                  │                         │
                  v                         v
    ┌─────────────────────────────────┐   ┌─────────────────────────────────┐
    │      内存预占                   │   │       CPU预占                   │
    │  - sbxInProgress.MiBMemory      │   │  - sbxInProgress.CPUs           │
    │  - 防止内存超分配               │   │  - 防止CPU超分配                │
    └─────────────────┬───────────────┘   └─────────────────┬───────────────┘
                     │                                     │
                     └──────────────┬──────────────────────┘
                                   |
                                   v
                  ┌─────────────────────────────────────┐
                  │       实时监控指标                   │
                  │  - node.CPUUsage.Load()             │
                  │  - node.RamUsage.Load()             │
                  │  - node.createFails.Load()          │
                  │  - node.sbxsInProgress.Count()      │
                  └─────────────────┬───────────────────┘
                                   |
                                   v
                  ┌─────────────────────────────────────┐
                  │       健康检查循环                   │
                  │  - 每20秒状态记录                   │
                  │  - gRPC连接状态监控                 │
                  │  - Nomad节点状态同步                │
                  └─────────────────────────────────────┘
```

## 故障处理和容错机制

```
                        [故障检测触发]
                               |
                  ┌────────────┴────────────┐
                  │                         │
                  v                         v
    ┌─────────────────────────────────┐   ┌─────────────────────────────────┐
    │      节点级别故障               │   │       请求级别故障               │
    │  - 连接状态: Shutdown           │   │  - 沙盒创建失败                 │
    │  - 连接状态: TransientFailure   │   │  - 资源不足                     │
    │  - 健康检查失败                 │   │  - 超时错误                     │
    └─────────────────┬───────────────┘   └─────────────────┬───────────────┘
                     │                                     │
                     v                                     v
    ┌─────────────────────────────────┐   ┌─────────────────────────────────┐
    │      节点状态更新               │   │       重试机制                   │
    │  - 标记为 Unhealthy             │   │  - 最大重试3次                  │
    │  - 从调度池中排除               │   │  - 指数退避                     │
    │  - 触发告警                     │   │  - 排除失败节点                 │
    └─────────────────┬───────────────┘   └─────────────────┬───────────────┘
                     │                                     │
                     └──────────────┬──────────────────────┘
                                   |
                                   v
                  ┌─────────────────────────────────────┐
                  │       自动恢复机制                   │
                  │  - 节点自愈检查                     │
                  │  - 重新加入调度池                   │
                  │  - 负载重新平衡                     │
                  └─────────────────────────────────────┘
```

## 关键性能指标

### 调度决策指标
- **节点CPU使用率**: `node.CPUUsage.Load() + 进行中实例CPU需求`
- **内存使用率**: `node.RamUsage.Load() + 进行中实例内存需求`
- **并发启动限制**: `maxStartingInstancesPerNode = 3`
- **失败计数权重**: `node.createFails.Load()`

### 超时和重试配置
- **最大重试次数**: `maxNodeRetries = 3`
- **节点选择超时**: `leastBusyNodeTimeout = 60s`
- **轮询间隔**: `10ms`
- **实例过期时间**: `InstanceExpiration = 15s`

### 资源预约机制
- **团队并发限制**: `team.Tier.ConcurrentInstances`
- **资源预占**: 防止竞态条件
- **自动释放**: 通过defer确保资源清理

## 算法优势

1. **智能负载均衡**: 基于实时CPU使用率选择最空闲节点
2. **故障容错**: 多重重试机制和节点排除策略
3. **资源保护**: 预占机制防止资源超分配
4. **恢复优化**: 快照恢复优先选择原始节点
5. **并发控制**: 多层次的并发限制和资源预约
6. **实时监控**: 全面的性能指标和健康检查

这个调度算法确保了E2B Infrastructure能够在高并发环境下稳定、高效地分配和管理沙盒资源，同时提供了强大的故障恢复能力。